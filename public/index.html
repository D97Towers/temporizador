<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Temporizador de Juegos</title>
  <!-- Deployment trigger: v1.8 - HAMBURGER BUTTON + DESKTOP MENU: Simplified hamburger + left-aligned desktop menu -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
      box-sizing: border-box;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 10px;
      box-sizing: border-box;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
      position: relative;
      padding-left: 80px;
      padding-right: 20px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    /* Navegaci칩n principal */
         .main-nav {
           display: flex;
           justify-content: flex-start;
           gap: 10px;
           margin-top: 20px;
           flex-wrap: wrap;
           margin-left: 20px;
         }

         /* Desktop Sidebar */
         .desktop-sidebar {
           display: none;
         }

         .main-content {
           width: 100%;
         }

         /* Desktop - mostrar sidebar y ocultar men칰 m칩vil */
         @media (min-width: 769px) {
           .desktop-sidebar {
             display: flex;
             flex-direction: column;
             position: fixed;
             left: 0;
             top: 0;
             width: 250px;
             height: 100vh;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             z-index: 100;
             box-shadow: 2px 0 10px rgba(0,0,0,0.3);
           }

           .sidebar-header {
             padding: 30px 20px 20px;
             border-bottom: 1px solid rgba(255,255,255,0.1);
           }

           .sidebar-header h2 {
      color: white;
             font-size: 1.5rem;
             font-weight: 600;
             text-align: center;
             margin: 0;
           }

           .desktop-nav {
             padding: 20px 0;
             flex: 1;
           }

           .desktop-nav-btn {
             display: flex;
             align-items: center;
             gap: 12px;
             width: 100%;
             padding: 15px 20px;
             background: none;
             border: none;
             color: rgba(255,255,255,0.9);
             font-size: 14px;
             font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
             text-align: left;
             border-left: 3px solid transparent;
           }

           .desktop-nav-btn:hover {
             background: rgba(255,255,255,0.15);
             color: white;
             transform: translateX(5px);
           }

           .desktop-nav-btn.active {
             background: rgba(255,255,255,0.2);
             color: white;
             border-left-color: white;
             font-weight: 600;
           }

           .desktop-nav-btn i {
             font-size: 16px;
             width: 20px;
           }

           .main-content {
             margin-left: 250px;
             width: calc(100% - 250px);
           }
           
           .mobile-menu-toggle {
             display: none !important;
           }
           
           .header {
             padding-left: 20px !important;
             text-align: center !important;
           }
         }

         /* Men칰 lateral para m칩viles */
         .mobile-menu-toggle {
           display: none;
           background: rgba(255, 255, 255, 0.1);
      color: white;
           border: 2px solid rgba(255, 255, 255, 0.3);
           padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      width: 40px;
      height: 40px;
           transition: all 0.3s ease;
           box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
         .hamburger-lines {
           display: flex;
           flex-direction: column;
           gap: 3px;
           width: 18px;
         }

         .hamburger-lines span {
           width: 100%;
           height: 2px;
           background-color: white;
           border-radius: 1px;
           transition: all 0.3s ease;
         }

         .mobile-menu-toggle:hover {
           background: rgba(255, 255, 255, 0.2);
           border-color: rgba(255, 255, 255, 0.5);
         }

         /* Asegurar que el bot칩n no se vea afectado por otros estilos */
         .mobile-menu-toggle * {
           text-align: center !important;
           position: static !important;
         }

         /* Sobrescribir estilos globales de botones */
         .mobile-menu-toggle {
           width: auto !important;
           max-width: none !important;
           min-width: auto !important;
           flex: none !important;
           box-sizing: border-box !important;
         }

         .sidebar {
           position: fixed;
           top: 0;
           left: -300px;
           width: 280px;
           height: 100vh;
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
           padding: 80px 20px 20px;
           z-index: 1002;
           transition: left 0.3s ease;
           box-shadow: 2px 0 10px rgba(0,0,0,0.3);
         }

         .sidebar.open {
           left: 0;
         }

         .sidebar .nav-btn {
           width: 100%;
           margin-bottom: 10px;
           justify-content: flex-start;
           min-width: auto;
         }

         .sidebar-overlay {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: rgba(0, 0, 0, 0.5);
           z-index: 1000;
           opacity: 0;
           visibility: hidden;
           transition: all 0.3s ease;
         }

         .sidebar-overlay.active {
           opacity: 1;
           visibility: visible;
         }

         /* Sistema de b칰squeda de ni침os */
         .child-search-container {
           position: relative;
         }

         .child-search-results {
           position: absolute;
           top: 100%;
           left: 0;
           right: 0;
           background: white;
           border: 1px solid #ddd;
           border-radius: 8px;
           max-height: 200px;
           overflow-y: auto;
      z-index: 100;
           display: none;
           box-shadow: 0 4px 12px rgba(0,0,0,0.15);
         }

         .child-search-results.show {
           display: block;
         }

         .child-search-item {
           padding: 12px 15px;
           cursor: pointer;
           border-bottom: 1px solid #f0f0f0;
           display: flex;
           align-items: center;
           gap: 10px;
           transition: background-color 0.2s ease;
         }

         .child-search-item:hover {
           background-color: #f8f9fa;
         }

         .child-search-item:last-child {
           border-bottom: none;
         }

         .child-search-item .child-avatar {
           width: 30px;
           height: 30px;
           border-radius: 50%;
           background: linear-gradient(135deg, #667eea, #764ba2);
           color: white;
      display: flex;
      align-items: center;
      justify-content: center;
           font-weight: bold;
           font-size: 14px;
         }

         .child-search-item .child-info {
           flex: 1;
         }

         .child-search-item .child-name {
           font-weight: 600;
           color: #333;
           margin-bottom: 2px;
         }

         .child-search-item .child-parents {
           font-size: 12px;
           color: #666;
         }

         .child-search-item .child-stats {
           font-size: 11px;
           color: #999;
           text-align: right;
         }

         .no-results {
           padding: 15px;
           text-align: center;
           color: #666;
           font-style: italic;
         }

    .nav-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      min-width: 140px;
      justify-content: center;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .nav-btn.active {
      background: rgba(255, 255, 255, 0.9);
      color: #667eea;
      border-color: white;
    }

    .shortcut-key {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 8px;
      opacity: 0.8;
    }

    /* Secciones */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Dashboard de estad칤sticas */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .stat-label {
      color: #666;
      font-size: 1rem;
      margin-bottom: 5px;
    }

    .stat-description {
      color: #999;
      font-size: 0.9rem;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .ranking-list {
      list-style: none;
      padding: 0;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .ranking-item:nth-child(1) {
      border-left-color: #ffd700;
      background: linear-gradient(135deg, #fff9c4, #f8f9fa);
    }

    .ranking-item:nth-child(2) {
      border-left-color: #c0c0c0;
      background: linear-gradient(135deg, #f0f0f0, #f8f9fa);
    }

    .ranking-item:nth-child(3) {
      border-left-color: #cd7f32;
      background: linear-gradient(135deg, #ffe4b5, #f8f9fa);
    }

    .ranking-position {
      font-weight: bold;
      color: #667eea;
      font-size: 1.2rem;
      min-width: 30px;
    }

    .ranking-name {
      flex: 1;
      margin: 0 15px;
      font-weight: 500;
    }

    .ranking-time {
      color: #666;
      font-weight: 600;
    }
    
    /* Sync button removed for better UX - data syncs automatically */

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .card h2 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-row {
      display: flex;
      gap: 15px;
      align-items: end;
      flex-wrap: wrap;
    }

    .form-row .form-group {
      flex: 1;
      min-width: 120px;
    }

    .form-row .form-group:last-child {
      flex: 0 0 auto;
      min-width: 140px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
    }

    input, select, button {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
    }

    .list {
      list-style: none;
      margin-top: 15px;
    }

    .list-item {
      background: #f7fafc;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      overflow: hidden;
      word-wrap: break-word;
      position: relative;
    }

    .list-item:hover {
      background: #edf2f7;
      transform: translateX(5px);
    }

    .list-item.active {
      border-left-color: #38a169;
      background: #f0fff4;
    }

    .session-info {
      flex: 1;
      min-width: 0;
      margin-right: 10px;
    }

    .session-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 0;
      flex-shrink: 0;
    }

    .button-group {
      display: flex;
      gap: 3px;
      margin-top: 5px;
      flex-wrap: nowrap;
    }
    
    /* Estilos para avatares y identificadores 칰nicos */
    .child-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    
    .child-avatar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .child-avatar-small {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      font-weight: bold;
      font-size: 10px;
      margin-right: 5px;
    }
    
    .child-details {
      flex: 1;
      min-width: 0;
    }
    
    .original-name {
      display: block;
      color: #666;
      font-size: 11px;
      margin-top: 2px;
      font-style: italic;
    }
    
    /* Estilos para formulario mejorado de ni침os */
    .child-form {
      margin-bottom: 20px;
    }
    
    .child-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    .child-form input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    .child-form input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .child-form input[required] {
      border-color: #667eea;
    }
    
    .child-form .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .child-form .form-row .form-group {
      flex: 1;
    }
    
    .child-form {
      margin-bottom: 20px;
    }

    .child-form .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .child-form .form-group {
      flex: 1;
      min-width: 0;
    }

    .child-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .child-form input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .child-form input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .child-form small {
      display: block;
      color: #666;
      font-size: 12px;
      margin-top: 5px;
      font-style: italic;
    }

    /* Responsive design for mobile */
    @media (max-width: 768px) {
      .child-form .form-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .child-form .form-group {
        flex: none;
      }

      .child-info {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 8px;
      }

      .child-details {
        width: 100% !important;
      }

      .list-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .btn-small {
        align-self: flex-end;
        margin-top: 5px;
        padding: 3px 6px !important;
        font-size: 10px !important;
      }

      .delete-button-container {
        min-width: 50px;
        height: 28px;
      }

      .button-group-small {
        gap: 3px;
      }

      .list-item {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .child-info {
        margin-right: 0 !important;
      }

      .container {
        padding: 10px;
      }

      .card {
        margin-bottom: 15px;
      }

      h2 {
        font-size: 18px;
      }
    }

    /* Tablet responsive */
    @media (max-width: 1024px) and (min-width: 769px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .child-form .form-row {
        gap: 12px;
      }
    }
    
    /* Estilos para elementos de ni침os mejorados */
    .child-item {
      border-left: 4px solid #667eea;
      background: #f8f9ff;
      transition: all 0.3s ease;
    }

    .child-item:hover {
      background: #e8f2ff;
    }

    .child-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .nickname-text {
      color: #666;
      font-weight: 400;
      font-style: italic;
    }

    .child-time {
      color: #666;
      font-size: 14px;
    }

    .child-parents {
      color: #555;
      font-size: 12px;
      font-style: italic;
      margin: 2px 0;
      background: rgba(102, 126, 234, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
      border-left: 2px solid #667eea;
    }

    .btn-small {
      padding: 4px 8px !important;
      font-size: 11px !important;
      min-width: auto !important;
      border-radius: 5px !important;
      opacity: 0.8;
      transition: all 0.2s ease !important;
      width: auto !important;
      height: auto !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .btn-small:hover {
      opacity: 1;
      transform: none;
      background: #e53e3e !important;
    }

    .btn-small i {
      font-size: 10px !important;
    }

    .btn-edit {
      padding: 4px 8px !important;
      font-size: 11px !important;
      min-width: auto !important;
      border-radius: 5px !important;
      opacity: 0.8;
      transition: all 0.2s ease !important;
      width: auto !important;
      height: auto !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      border: none !important;
      margin-right: 5px !important;
    }

    .btn-edit:hover {
      opacity: 1;
      transform: none;
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
    }

    .btn-edit i {
      font-size: 10px !important;
    }

    .delete-button-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      min-width: 60px;
      height: 32px;
    }

    .button-group-small {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .parents-info {
      color: #555;
      font-size: 11px;
      font-style: italic;
      background: rgba(102, 126, 234, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
      border-left: 2px solid #667eea;
      margin: 2px 0;
      display: inline-block;
    }

    .history-parents {
      color: #555;
      font-size: 11px;
      font-style: italic;
      background: rgba(102, 126, 234, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
      border-left: 2px solid #667eea;
      margin: 2px 0;
      display: block;
    }

    /* Historial compacto y responsive */
    .history-item {
      background: white;
      margin-bottom: 8px;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      transition: all 0.2s ease;
      border-left: 4px solid transparent;
    }

    .history-item:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .history-item.active {
      border-left-color: #4CAF50;
      background: linear-gradient(135deg, #f8fff8, #ffffff);
    }

    .history-item.completed {
      border-left-color: #2196F3;
      opacity: 0.8;
    }

    .history-item.expired {
      border-left-color: #f44336;
      background: linear-gradient(135deg, #fff5f5, #ffffff);
    }

    .history-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
    }

    .history-icon.active {
      background: linear-gradient(135deg, #4CAF50, #45a049);
    }

    .history-icon.completed {
      background: linear-gradient(135deg, #2196F3, #1976D2);
    }

    .history-icon.expired {
      background: linear-gradient(135deg, #f44336, #d32f2f);
    }

    .history-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .history-title {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-subtitle {
      font-size: 12px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-meta {
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 80px;
    }

    .history-duration {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      color: white;
    }

    .history-duration.active {
      background: #4CAF50;
    }

    .history-duration.completed {
      background: #2196F3;
    }

    .history-duration.expired {
      background: #f44336;
    }

    .history-time {
      font-size: 11px;
      color: #999;
    }

    /* Bot칩n para expandir/colapsar historial */
    .history-toggle {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      margin: 10px 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-toggle:hover {
      background: linear-gradient(135deg, #5a6fd8, #6a4190);
      transform: translateY(-1px);
    }

    .history-toggle i {
      transition: transform 0.3s ease;
    }

    .history-toggle.expanded i {
      transform: rotate(180deg);
    }

    .history-hidden {
      display: none;
    }

    .history-summary {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 8px 12px;
      margin: 8px 0;
      font-size: 12px;
      color: #666;
      text-align: center;
      border: 1px solid #e9ecef;
    }

    /* Responsive design para historial */
    @media (max-width: 768px) {
      .history-item {
        grid-template-columns: auto 1fr;
        gap: 8px;
      }

      .history-meta {
        grid-column: 1 / -1;
        text-align: left;
        flex-direction: row;
        justify-content: space-between;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #eee;
      }

      .history-content {
        grid-column: 2;
      }
    }

    @media (max-width: 480px) {
      .history-item {
        padding: 10px;
        margin-bottom: 6px;
      }

      .history-icon {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .history-title {
        font-size: 13px;
      }

      .history-subtitle {
        font-size: 11px;
      }

      .history-toggle {
        padding: 6px 12px;
        font-size: 11px;
      }
    }

    .timer {
      font-weight: bold;
      color: #38a169;
      font-family: 'Courier New', monospace;
      font-size: 1.1rem;
      line-height: 1.3;
      text-align: center;
      min-width: 120px;
    }

    .timer.warning {
      color: #f6ad55;
    }

    .timer.danger {
      color: #e53e3e;
      animation: pulse 1s infinite;
    }

    .timer strong {
      display: block;
      font-size: 1.2rem;
      margin-bottom: 2px;
    }

    .timer small {
      font-size: 0.9rem;
      opacity: 0.8;
      font-weight: normal;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-message {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .status-message.show {
      transform: translateX(0);
    }

    .status-message.success {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    }

    .status-message.error {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    }

    .status-message.warning {
      background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal h2 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .modal p {
      font-size: 1.1rem;
      margin-bottom: 30px;
      color: #666;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .modal-buttons button {
      flex: 1;
      max-width: 120px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .extend-time {
      background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
      margin-left: 5px;
      padding: 5px 10px;
      font-size: 12px;
    }

    /* Responsive Design para navegaci칩n */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-number {
        font-size: 2rem;
      }
      
      .chart-container {
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      .nav-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .ranking-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .ranking-meta {
        display: flex;
        justify-content: space-between;
        width: 100%;
      }
    }

    /* Sistema de alertas persistentes */
    .alert-container {
      position: fixed;
      top: 90px;
      right: 20px;
      z-index: 10000;
      max-width: 350px;
      pointer-events: none;
    }
    
    .persistent-alert {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border-radius: 12px;
      padding: 0;
      margin-bottom: 10px;
      box-shadow: 0 8px 32px rgba(255, 107, 107, 0.3);
      transform: translateX(0);
      opacity: 1;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      border: 2px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .alert-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
    }
    
    .alert-message {
      flex: 1;
      font-weight: 600;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .alert-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      margin-left: 12px;
      border-radius: 6px;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    
    .alert-close:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .alert-close i {
      font-size: 12px;
    }
    
    /* Animaci칩n de entrada */
    .persistent-alert {
      animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .mobile-menu-toggle {
        display: block !important;
      }
      
      .main-nav {
        display: none !important;
      }
      
      .header {
        padding-left: 20px !important;
        text-align: center !important;
      }
      
      .container {
        padding-left: 10px;
      }
      
      .header {
        padding-left: 20px !important;
        padding-right: 20px !important;
        text-align: center !important;
      }

      .header h1 {
        font-size: 1.5rem;
        margin-left: 0;
      }
      
      .header p {
        font-size: 0.9rem;
        margin-left: 0;
      }

      .grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .card {
        padding: 20px;
      }

      .form-row {
        flex-direction: column !important;
        gap: 10px;
        align-items: stretch !important;
      }

      .form-row .form-group {
        min-width: auto !important;
        max-width: none !important;
        flex: none !important;
        width: 100% !important;
      }

      .form-row .form-group:last-child {
        min-width: auto !important;
        max-width: none !important;
        flex: none !important;
        width: 100% !important;
      }

      input, select, button {
        width: 100% !important;
        max-width: none !important;
        font-size: 16px; /* Evita zoom en iOS */
      }
      
      /* Mejorar alertas en m칩viles */
      .alert-container {
        top: 70px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      .persistent-alert {
        margin-bottom: 8px;
      }
      
      .alert-content {
        padding: 12px 16px;
      }
      
      .alert-message {
        font-size: 13px;
      }
      
      /* Mejorar botones en m칩viles */
      .list-item .btn {
        padding: 8px 12px;
        font-size: 12px;
        margin: 2px;
      }

      .status-message {
        right: 10px;
        left: 10px;
        transform: translateY(-100px);
      }

      .status-message.show {
        transform: translateY(0);
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.8rem;
      }
      
      /* Sync button responsive rules removed */

      .card {
        padding: 15px;
      }

      .modal-content {
        padding: 30px 20px;
      }

      .form-row {
        flex-direction: column !important;
        gap: 8px;
      }

      .form-row .form-group {
        width: 100% !important;
        flex: none !important;
      }

      input, select, button {
        width: 100% !important;
        padding: 10px 12px;
        font-size: 14px;
      }
    }

    /* Reglas responsive para sesiones activas */
    @media (max-width: 768px) {
      .list-item.active {
        flex-direction: column;
        align-items: stretch;
      }
      
      .session-controls {
        align-items: center;
        margin-top: 10px;
      }
      
      .button-group {
        justify-content: center;
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .button-group button {
        padding: 6px 10px !important;
        font-size: 12px !important;
      }
    }

    /* Regla espec칤fica para pantallas muy peque침as */
    @media (max-width: 360px) {
      .form-row {
        flex-direction: column !important;
        gap: 5px;
      }

      .form-row .form-group {
        width: 100% !important;
        margin-bottom: 10px;
      }

      input, select, button {
        width: 100% !important;
        padding: 8px 10px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
    <!-- Men칰 m칩vil - Posicionado fuera del flujo normal -->
    <div style="position: fixed; top: 20px; left: 20px; z-index: 9999;">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <div class="hamburger-lines">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
    </div>
    
    <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    
    <div class="sidebar" id="sidebar">
      <button onclick="showSection('dashboard')" class="nav-btn" id="nav-dashboard">
        <i class="fas fa-chart-bar"></i> Dashboard <span class="shortcut-key">1</span>
      </button>
      <button onclick="showSection('sessions')" class="nav-btn" id="nav-sessions">
        <i class="fas fa-play-circle"></i> Sesiones <span class="shortcut-key">2</span>
      </button>
      <button onclick="showSection('children')" class="nav-btn" id="nav-children">
        <i class="fas fa-child"></i> Ni침os <span class="shortcut-key">3</span>
      </button>
      <button onclick="showSection('games')" class="nav-btn" id="nav-games">
        <i class="fas fa-gamepad"></i> Juegos <span class="shortcut-key">4</span>
      </button>
    </div>

  <!-- Desktop Sidebar -->
  <div class="desktop-sidebar">
    <div class="sidebar-header">
      <h2><i class="fas fa-gamepad"></i> Temporizador</h2>
    </div>
    <nav class="desktop-nav">
      <button onclick="showSection('dashboard')" class="desktop-nav-btn" id="nav-dashboard">
        <i class="fas fa-chart-bar"></i> Dashboard
      </button>
      <button onclick="showSection('sessions')" class="desktop-nav-btn" id="nav-sessions">
        <i class="fas fa-play-circle"></i> Sesiones
      </button>
      <button onclick="showSection('children')" class="desktop-nav-btn" id="nav-children">
        <i class="fas fa-child"></i> Ni침os
      </button>
      <button onclick="showSection('games')" class="desktop-nav-btn" id="nav-games">
        <i class="fas fa-gamepad"></i> Juegos
      </button>
    </nav>
  </div>

  <div class="main-content">
    <div class="header">
      <h1><i class="fas fa-gamepad"></i> Temporizador de Juegos</h1>
      <p>Controla el tiempo de juego de los ni침os de forma divertida</p>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalChildren">0</div>
          <div class="stat-label">Ni침os Registrados</div>
          <div class="stat-description">Total de ni침os en el sistema</div>
          </div>
        <div class="stat-card">
          <div class="stat-number" id="totalGames">0</div>
          <div class="stat-label">Juegos Disponibles</div>
          <div class="stat-description">Juegos registrados</div>
          </div>
        <div class="stat-card">
          <div class="stat-number" id="activeSessionsCount">0</div>
          <div class="stat-label">Sesiones Activas</div>
          <div class="stat-description">Jugando ahora</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalTimePlayed">0</div>
          <div class="stat-label">Tiempo Total (min)</div>
          <div class="stat-description">Tiempo jugado acumulado</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">游끥 Ranking de Tiempo Jugado</div>
        <ul class="ranking-list" id="childrenRanking">
          <li class="ranking-item">No hay datos disponibles</li>
        </ul>
          </div>

      <div class="chart-container">
        <div class="chart-title">游꿡 Juegos M치s Populares</div>
        <ul class="ranking-list" id="gamesRanking">
          <li class="ranking-item">No hay datos disponibles</li>
        </ul>
          </div>
      </div>

    <!-- Sessions Section -->
    <div id="sessions-section" class="section">
      <div class="grid">
      <!-- Iniciar Sesi칩n -->
      <div class="card">
        <h2><i class="fas fa-play-circle"></i> Iniciar Sesi칩n de Juego</h2>
        <div class="form-group">
          <label><i class="fas fa-user"></i> Ni침o:</label>
                     <div class="child-search-container">
                       <input type="text" id="childSearchInput" placeholder="Buscar ni침o por nombre..." autocomplete="off">
                       <div class="child-search-results" id="childSearchResults"></div>
                       <input type="hidden" id="selectedChildId" value="">
                     </div>
        </div>
        <div class="form-group">
          <label><i class="fas fa-gamepad"></i> Juego:</label>
          <select id="gameSelect">
            <option value="">Seleccione un juego</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fas fa-clock"></i> Tiempo (minutos):</label>
          <input type="number" id="durationInput" min="1" max="180" value="15">
        </div>
        <button onclick="startSession()" id="startBtn">
          <i class="fas fa-play"></i> Iniciar Sesi칩n
        </button>
      </div>

      <!-- Sesiones Activas -->
      <div class="card">
        <h2><i class="fas fa-stopwatch"></i> Sesiones Activas</h2>
        <ul class="list" id="activeSessions">
          <li class="list-item">Cargando sesiones activas...</li>
        </ul>
      </div>

      <!-- Historial -->
      <div class="card">
        <h2><i class="fas fa-history"></i> Historial de Sesiones</h2>
        <ul class="list" id="sessionHistory"></ul>
      </div>
    </div>
  </div>

    <!-- Children Section -->
    <div id="children-section" class="section">
      <div class="grid">
        <!-- Registrar Ni침o -->
        <div class="card">
          <h2><i class="fas fa-child"></i> Registrar Ni침o</h2>
            <div class="child-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="childName">Nombre del ni침o</label>
                  <input type="text" id="childName" placeholder="Ej: Juan" maxlength="30" required>
                </div>
                <div class="form-group">
                  <label for="childNickname">Apodo (opcional)</label>
                  <input type="text" id="childNickname" placeholder="Ej: Juanito" maxlength="20">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="fatherName">Nombre del padre (opcional)</label>
                  <input type="text" id="fatherName" placeholder="Ej: Carlos" maxlength="30">
                </div>
                <div class="form-group">
                  <label for="motherName">Nombre de la madre (opcional)</label>
                  <input type="text" id="motherName" placeholder="Ej: Mar칤a" maxlength="30">
                </div>
              </div>
              <button onclick="addChild()" id="addChildBtn" class="btn-primary">
                <i class="fas fa-plus"></i> AGREGAR NI칌O
              </button>
              <button onclick="debugChildren()" class="btn-secondary" style="margin-left: 10px;">
                <i class="fas fa-bug"></i> DEBUG
              </button>
            </div>
          <ul class="list" id="childrenList"></ul>
        </div>
      </div>
    </div>

    <!-- Games Section -->
    <div id="games-section" class="section">
      <div class="grid">
        <!-- Registrar Juego -->
        <div class="card">
          <h2><i class="fas fa-dice"></i> Registrar Juego</h2>
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="gameName" placeholder="Nombre del juego" maxlength="50">
            </div>
            <div class="form-group">
              <button onclick="addGame()" id="addGameBtn">
                <i class="fas fa-plus"></i> Agregar Juego
              </button>
            </div>
          </div>
          <ul class="list" id="gamesList"></ul>
        </div>
      </div>
    </div>
  </div>
  </div> <!-- Cerrar main-content -->

  <!-- Status Message -->
  <div id="statusMessage" class="status-message"></div>

  <!-- Modal -->
  <div id="customModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle"><i class="fas fa-bell"></i> 춰Tiempo terminado!</h2>
      <p id="modalMsg"></p>
      <button onclick="closeModal()" class="btn-success">
        <i class="fas fa-check"></i> Entendido
      </button>
    </div>
  </div>

  <!-- Modal de Extensi칩n de Tiempo -->
  <div id="extendModal" class="modal">
    <div class="modal-content">
      <h2><i class="fas fa-clock"></i> Extender Tiempo</h2>
      <p id="extendMsg"></p>
      <div class="form-group">
        <label>Tiempo adicional (minutos):</label>
        <input type="number" id="extendTimeInput" min="1" max="60" value="5">
      </div>
      <div class="modal-buttons">
        <button onclick="confirmExtendTime()" class="btn-success">
          <i class="fas fa-plus"></i> Extender
        </button>
        <button onclick="closeExtendModal()" class="btn-danger">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Edici칩n de Ni침o -->
  <div id="editChildModal" class="modal">
    <div class="modal-content">
      <h2><i class="fas fa-edit"></i> Editar Informaci칩n del Ni침o</h2>
      <div class="form-group">
        <label for="editChildName">Nombre del ni침o:</label>
        <input type="text" id="editChildName" placeholder="Ej: Juan" maxlength="30" required>
      </div>
      <div class="form-group">
        <label for="editChildNickname">Apodo (opcional):</label>
        <input type="text" id="editChildNickname" placeholder="Ej: Juanito" maxlength="20">
      </div>
      <div class="form-group">
        <label for="editFatherName">Nombre del padre (opcional):</label>
        <input type="text" id="editFatherName" placeholder="Ej: Carlos" maxlength="30">
      </div>
      <div class="form-group">
        <label for="editMotherName">Nombre de la madre (opcional):</label>
        <input type="text" id="editMotherName" placeholder="Ej: Mar칤a" maxlength="30">
      </div>
      <div class="modal-buttons">
        <button onclick="confirmEditChild()" class="btn-success">
          <i class="fas fa-save"></i> Guardar Cambios
        </button>
        <button onclick="closeEditChildModal()" class="btn-danger">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Configuraci칩n de API - detectar entorno
    const api = window.location.origin;
    console.log('API URL:', api);
    console.log('Environment:', window.location.hostname);

    // Variables para el dashboard
    let dashboardStats = null;
    
    // Variables para notificaciones
    let notificationPermission = null;
    
    // Variables para atajos de teclado
    let keyboardShortcuts = {
      '1': () => showSection('dashboard'),
      '2': () => showSection('sessions'),
      '3': () => showSection('children'),
      '4': () => showSection('games'),
      'Escape': () => closeModal() || closeExtendModal() || closeEditChildModal()
    };

    // Funciones de notificaciones push
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('Este navegador no soporta notificaciones');
        return false;
      }
      
      if (Notification.permission === 'granted') {
        return true;
      }
      
      if (Notification.permission === 'denied') {
        console.log('Notificaciones denegadas por el usuario');
        return false;
      }
      
      const permission = await Notification.requestPermission();
      notificationPermission = permission === 'granted';
      return notificationPermission;
    }

    function showBrowserNotification(title, message, icon = null) {
      if (notificationPermission && 'Notification' in window) {
        const notification = new Notification(title, {
          body: message,
          icon: icon || '/favicon.ico',
          tag: 'temporizador-juegos',
          requireInteraction: true
        });
        
        // Auto-cerrar despu칠s de 10 segundos
        setTimeout(() => {
          notification.close();
        }, 10000);
        
        // Cerrar al hacer click
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    // Funciones de navegaci칩n
    function showSection(sectionName) {
      // Ocultar todas las secciones
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Desactivar todos los botones de navegaci칩n
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Mostrar la secci칩n seleccionada
      const section = document.getElementById(sectionName + '-section');
      if (section) {
        section.classList.add('active');
      }
      
      // Activar el bot칩n correspondiente (tanto desktop como m칩vil)
      const desktopNavBtn = document.getElementById('nav-' + sectionName);
      const mobileNavBtn = document.querySelector('.sidebar .nav-btn[id="nav-' + sectionName + '"]');
      
      // Desactivar todos los botones primero
      document.querySelectorAll('.desktop-nav-btn, .nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Activar el bot칩n correspondiente
      if (desktopNavBtn) {
        desktopNavBtn.classList.add('active');
      }
      if (mobileNavBtn) {
        mobileNavBtn.classList.add('active');
      }
      
      // Actualizar dashboard si es necesario
      if (sectionName === 'dashboard') {
        updateDashboard();
      }
      
      // Cerrar men칰 m칩vil al navegar
      closeMobileMenu();
      
      // Limpiar alertas persistentes al cambiar de secci칩n
      clearAllPersistentAlerts();
      
      // Guardar secci칩n activa en localStorage
      localStorage.setItem('activeSection', sectionName);
    }

    // Funciones del men칰 m칩vil
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      
      sidebar.classList.toggle('open');
      overlay.classList.toggle('active');
    }

    function closeMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      
      sidebar.classList.remove('open');
      overlay.classList.remove('active');
    }

    // Sistema de b칰squeda de ni침os
    function initializeChildSearch() {
      const searchInput = document.getElementById('childSearchInput');
      const searchResults = document.getElementById('childSearchResults');
      const selectedChildId = document.getElementById('selectedChildId');

      if (!searchInput) return;

      let searchTimeout;

      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim().toLowerCase();

        if (query.length < 2) {
          hideSearchResults();
          return;
        }

        searchTimeout = setTimeout(() => {
          searchChildren(query);
        }, 300);
      });

      searchInput.addEventListener('focus', () => {
        if (searchInput.value.trim().length >= 2) {
          searchChildren(searchInput.value.trim().toLowerCase());
        }
      });

      // Cerrar resultados al hacer clic fuera
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.child-search-container')) {
          hideSearchResults();
        }
      });
    }

    function searchChildren(query) {
      const results = childrenCache.filter(child => {
        const name = (child.displayName || child.name).toLowerCase();
        const fatherName = (child.fatherName || '').toLowerCase();
        const motherName = (child.motherName || '').toLowerCase();
        
        return name.includes(query) || 
               fatherName.includes(query) || 
               motherName.includes(query);
      });

      displaySearchResults(results);
    }

    function displaySearchResults(results) {
      const searchResults = document.getElementById('childSearchResults');
      const searchInput = document.getElementById('childSearchInput');

      if (!searchResults || !searchInput) return;

      if (results.length === 0) {
        searchResults.innerHTML = '<div class="no-results">No se encontraron ni침os</div>';
      } else {
        searchResults.innerHTML = results.map(child => {
          const displayName = child.displayName || child.name;
          const avatar = child.avatar || child.name.charAt(0).toUpperCase();
          
          let parentsInfo = '';
          if (child.fatherName && child.motherName) {
            parentsInfo = `${child.fatherName} & ${child.motherName}`;
          } else if (child.fatherName) {
            parentsInfo = `Pap치: ${child.fatherName}`;
          } else if (child.motherName) {
            parentsInfo = `Mam치: ${child.motherName}`;
          }

          return `
            <div class="child-search-item" onclick="selectChild(${child.id}, '${displayName.replace(/'/g, "\\'")}')">
              <div class="child-avatar">${avatar}</div>
              <div class="child-info">
                <div class="child-name">${displayName}</div>
                ${parentsInfo ? `<div class="child-parents">${parentsInfo}</div>` : ''}
              </div>
              <div class="child-stats">${child.totalTimePlayed} min</div>
            </div>
          `;
        }).join('');
      }

      searchResults.classList.add('show');
    }

    function selectChild(childId, childName) {
      const searchInput = document.getElementById('childSearchInput');
      const selectedChildId = document.getElementById('selectedChildId');
      const searchResults = document.getElementById('childSearchResults');

      if (searchInput) {
        searchInput.value = childName;
      }
      if (selectedChildId) {
        selectedChildId.value = childId;
      }

      hideSearchResults();
    }

    function hideSearchResults() {
      const searchResults = document.getElementById('childSearchResults');
      if (searchResults) {
        searchResults.classList.remove('show');
      }
    }

    // Funciones del dashboard
    async function fetchDashboardStats() {
      try {
        const res = await fetchWithRetry(api + '/admin/status');
        if (res.ok) {
          dashboardStats = await res.json();
          return dashboardStats;
        }
      } catch (error) {
        console.error('Error fetching dashboard stats:', error);
      }
      return null;
    }

    function updateDashboard() {
      if (!dashboardStats) {
        fetchDashboardStats().then(() => {
          if (dashboardStats) {
            renderDashboard();
          }
        });
      } else {
        renderDashboard();
      }
    }

    function renderDashboard() {
      if (!dashboardStats) return;

      // Actualizar estad칤sticas principales
      document.getElementById('totalChildren').textContent = dashboardStats.totalChildren || 0;
      document.getElementById('totalGames').textContent = dashboardStats.totalGames || 0;
      document.getElementById('activeSessionsCount').textContent = dashboardStats.activeSessions || 0;
      document.getElementById('totalTimePlayed').textContent = dashboardStats.totalTimePlayed || 0;

      // Actualizar ranking de ni침os
      const childrenRanking = document.getElementById('childrenRanking');
      if (dashboardStats.childrenStats && dashboardStats.childrenStats.length > 0) {
        childrenRanking.innerHTML = dashboardStats.childrenStats.map((child, index) => `
          <li class="ranking-item">
            <div class="ranking-position">${index + 1}춿</div>
            <div class="ranking-name">${child.name}</div>
            <div class="ranking-time">${child.totalTimePlayed} min</div>
          </li>
        `).join('');
      } else {
        childrenRanking.innerHTML = '<li class="ranking-item">No hay datos disponibles</li>';
      }

      // Actualizar ranking de juegos
      const gamesRanking = document.getElementById('gamesRanking');
      if (dashboardStats.gamesStats && dashboardStats.gamesStats.length > 0) {
        gamesRanking.innerHTML = dashboardStats.gamesStats.map((game, index) => `
          <li class="ranking-item">
            <div class="ranking-position">${index + 1}춿</div>
            <div class="ranking-name">${game.name}</div>
            <div class="ranking-time">${game.totalTimePlayed} min</div>
          </li>
        `).join('');
      } else {
        gamesRanking.innerHTML = '<li class="ranking-item">No hay datos disponibles</li>';
      }
    }

    // Estado de la aplicaci칩n - ROBUSTO
    let isLoading = false;
    let activeSessionsData = [];
    let childrenCache = [];
    let gamesCache = [];
    let timerIntervals = new Map();
    let currentExtendSession = null;
    let currentEditChild = null; // Para almacenar el ID del ni침o que se est치 editando
    let isInitialized = false;
    let isFirstLoad = true;
    let alertedSessions = new Set(); // Para evitar alertas duplicadas

    // Utilidades mejoradas
    function showStatusMessage(text, type = 'success', sessionId = null) {
      const msg = document.getElementById('statusMessage');
      
      // Si es una alerta de sesi칩n, verificar si ya se mostr칩
      if (sessionId && alertedSessions.has(sessionId)) {
        return; // No mostrar alerta duplicada
      }
      
      // Reproducir sonido seg칰n el tipo
      if (type === 'warning' || type === 'danger') {
        playNotificationSound(type);
      }
      
      // Limpiar cualquier timeout anterior
      if (msg.timeoutId) {
        clearTimeout(msg.timeoutId);
      }
      
      msg.textContent = text;
      msg.className = `status-message ${type} show`;
      
      // Marcar sesi칩n como alertada si es una alerta de sesi칩n
      if (sessionId) {
        alertedSessions.add(sessionId);
      }
      
      // Auto-ocultar despu칠s de 1.5 segundos para mensajes m치s cortos
      const timeoutDuration = text.length < 10 ? 1500 : 3000;
      msg.timeoutId = setTimeout(() => {
        msg.classList.remove('show');
        msg.timeoutId = null;
        
        // Limpiar alerta de sesi칩n despu칠s de mostrar
        if (sessionId) {
          setTimeout(() => {
            alertedSessions.delete(sessionId);
          }, 1000);
        }
      }, timeoutDuration);
    }

    function showLoading(buttonId, show = true) {
      const button = document.getElementById(buttonId);
      if (!button) return;
      
      if (show) {
        button.disabled = true;
        button.innerHTML = '<div class="loading"></div> Procesando...';
      } else {
        button.disabled = false;
        // Restaurar texto original basado en el bot칩n
        if (buttonId === 'addChildBtn') {
          button.innerHTML = '<i class="fas fa-plus"></i> Agregar Ni침o';
        } else if (buttonId === 'addGameBtn') {
          button.innerHTML = '<i class="fas fa-plus"></i> Agregar Juego';
        } else if (buttonId === 'startBtn') {
          button.innerHTML = '<i class="fas fa-play"></i> Iniciar Sesi칩n';
        }
      }
    }

    // Funci칩n para limpiar todas las alertas de sesiones
    function clearAllSessionAlerts() {
      alertedSessions.clear();
      const msg = document.getElementById('statusMessage');
      if (msg) {
        if (msg.timeoutId) {
          clearTimeout(msg.timeoutId);
          msg.timeoutId = null;
        }
        msg.classList.remove('show');
        msg.textContent = '';
        msg.className = 'status-message';
      }
    }

    // Funci칩n para limpiar alerta espec칤fica de sesi칩n
    function clearSessionAlert(sessionId) {
      alertedSessions.delete(sessionId);
      const msg = document.getElementById('statusMessage');
      if (msg && msg.textContent.includes('quedan solo') && msg.textContent.includes('segundos')) {
        if (msg.timeoutId) {
          clearTimeout(msg.timeoutId);
          msg.timeoutId = null;
        }
        msg.classList.remove('show');
        msg.textContent = '';
        msg.className = 'status-message';
      }
    }

    // Sistema de notificaciones con sonido
    function playNotificationSound(type = 'default') {
      try {
        // Crear audio context para sonidos
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        let frequency = 800;
        let duration = 0.2;
        
        switch(type) {
          case 'warning':
            frequency = 600;
            duration = 0.3;
            break;
          case 'danger':
            frequency = 400;
            duration = 0.5;
            break;
          case 'success':
            frequency = 1000;
            duration = 0.2;
            break;
        }
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
      } catch (error) {
        console.log('Could not play notification sound:', error);
      }
    }

    // Sistema de alertas mejorado
    function showCustomModal(msg) {
      // Reproducir sonido de notificaci칩n
      playNotificationSound('danger');
      
      // Mostrar notificaci칩n del navegador
      showBrowserNotification('낋 Tiempo Terminado', msg);
      
      // Crear alerta persistente en la esquina
      const alertContainer = document.getElementById('alertContainer') || createAlertContainer();
      
      const alertId = 'alert-' + Date.now();
      const alert = document.createElement('div');
      alert.id = alertId;
      alert.className = 'persistent-alert';
      alert.innerHTML = `
        <div class="alert-content">
          <span class="alert-message">${msg}</span>
          <button class="alert-close" onclick="closeAlert('${alertId}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      alertContainer.appendChild(alert);
      
      // Auto-remover despu칠s de 10 segundos si no se cierra manualmente
      setTimeout(() => {
        if (document.getElementById(alertId)) {
          closeAlert(alertId);
        }
      }, 10000);
    }
    
    function createAlertContainer() {
      const container = document.createElement('div');
      container.id = 'alertContainer';
      container.className = 'alert-container';
      document.body.appendChild(container);
      return container;
    }
    
    function closeAlert(alertId) {
      const alert = document.getElementById(alertId);
      if (alert) {
        alert.style.opacity = '0';
        alert.style.transform = 'translateX(100%)';
        alert.style.transition = 'all 0.3s ease';
        setTimeout(() => {
          if (alert.parentNode) {
          alert.remove();
          }
        }, 300);
      }
    }

    // Funci칩n para limpiar todas las alertas persistentes
    function clearAllPersistentAlerts() {
      const alertContainer = document.getElementById('alertContainer');
      if (alertContainer) {
        alertContainer.innerHTML = '';
      }
      // Tambi칠n limpiar cualquier alerta que pueda estar fuera del contenedor
      document.querySelectorAll('.persistent-alert').forEach(alert => {
        alert.remove();
      });
    }

    function closeModal() {
      document.getElementById('customModal').classList.remove('show');
    }

    function showExtendModal(sessionId, childName) {
      currentExtendSession = sessionId;
      
      // Buscar informaci칩n del ni침o para mostrar padres si existen
      const session = activeSessionsData.find(s => s.id === sessionId);
      const child = session ? childrenCache.find(c => c.id === session.childId) : null;
      
      let displayMessage = `쮺u치nto tiempo adicional quiere darle a ${childName}?`;
      if (child && (child.fatherName || child.motherName)) {
        let parentsText = '';
        if (child.fatherName && child.motherName) {
          parentsText = ` (${child.fatherName} & ${child.motherName})`;
        } else if (child.fatherName) {
          parentsText = ` (Pap치: ${child.fatherName})`;
        } else if (child.motherName) {
          parentsText = ` (Mam치: ${child.motherName})`;
        }
        displayMessage = `쮺u치nto tiempo adicional quiere darle a ${childName}${parentsText}?`;
      }
      
      document.getElementById('extendMsg').textContent = displayMessage;
      document.getElementById('extendTimeInput').value = 5;
      document.getElementById('extendModal').classList.add('show');
    }

    function closeExtendModal() {
      document.getElementById('extendModal').classList.remove('show');
      currentExtendSession = null;
    }

    // Validaciones ROBUSTAS
    function validateName(name, type) {
      if (!name || name.trim().length === 0) {
        showStatusMessage(`Por favor ingrese el ${type}`, 'error');
        return false;
      }
      if (name.trim().length < 2) {
        showStatusMessage(`El ${type} debe tener al menos 2 caracteres`, 'error');
        return false;
      }
      if (name.trim().length > 50) {
        showStatusMessage(`El ${type} no puede tener m치s de 50 caracteres`, 'error');
        return false;
      }
      return true;
    }

    function validateSession(childId, gameId, duration) {
      if (!childId) {
        showStatusMessage('Por favor seleccione un ni침o', 'error');
        return false;
      }
      if (!gameId) {
        showStatusMessage('Por favor seleccione un juego', 'error');
        return false;
      }
      if (isNaN(duration)) {
        showStatusMessage('El tiempo debe ser un n칰mero v치lido', 'error');
        return false;
      }
      if (duration < 1) {
        showStatusMessage('El tiempo m칤nimo es 1 minuto', 'error');
        return false;
      }
      if (duration > 180) {
        showStatusMessage('El tiempo m치ximo es 180 minutos', 'error');
        return false;
      }
      return true;
    }

    // Funciones de fetch ROBUSTAS con reintentos
    async function fetchWithRetry(url, options = {}, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, options);
          if (res.ok) {
            return res;
          }
          if (i === retries - 1) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
        } catch (error) {
          if (i === retries - 1) {
            throw error;
          }
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
      }
    }

    async function fetchChildren() {
      try {
        console.log('Fetching children from:', api + '/children');
        const res = await fetchWithRetry(api + '/children');
        console.log('Children response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const children = await res.json();
        console.log('Children data received:', children);
        console.log('Children count:', children ? children.length : 0);
        
        // Verificar que los datos son v치lidos
        if (!Array.isArray(children)) {
          console.error('Invalid children data format:', children);
          throw new Error('Invalid children data format');
        }
        
        childrenCache = children || [];
        console.log('Children cache updated:', childrenCache.length, 'items');
        
        // Renderizar inmediatamente
        renderChildrenList(childrenCache);
        updateChildSelect(childrenCache);
        
        console.log('Children loaded successfully:', childrenCache);
        console.log('Children names:', childrenCache.map(c => c.name));
        
        return childrenCache;
      } catch (error) {
        console.error('Error fetching children:', error);
        showStatusMessage('Error al cargar la lista de ni침os', 'error');
        childrenCache = [];
        renderChildrenList([]);
        updateChildSelect([]);
        throw error; // Re-throw para que initializeApp pueda manejarlo
      }
    }

    // Funci칩n de debug temporal
    async function debugChildren() {
      console.log('=== DEBUG CHILDREN ===');
      console.log('Current childrenCache:', childrenCache);
      console.log('ChildrenCache length:', childrenCache.length);
      
      try {
        console.log('Fetching fresh data from API...');
        const res = await fetchWithRetry(api + '/children');
        const freshData = await res.json();
        console.log('Fresh data from API:', freshData);
        console.log('Fresh data length:', freshData.length);
        
        childrenCache = freshData || [];
        renderChildrenList(childrenCache);
        console.log('Children list refreshed with debug data');
      } catch (error) {
        console.error('Debug fetch error:', error);
      }
    }

    async function fetchGames() {
      try {
        console.log('Fetching games from:', api + '/games');
        const res = await fetchWithRetry(api + '/games');
        console.log('Games response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const games = await res.json();
        console.log('Games data received:', games);
        
        gamesCache = games || [];
        renderGamesList(gamesCache);
        updateGameSelect(gamesCache);
        console.log('Games loaded successfully:', gamesCache);
      } catch (error) {
        console.error('Error fetching games:', error);
        showStatusMessage('Error al cargar la lista de juegos', 'error');
        gamesCache = [];
        renderGamesList([]);
        updateGameSelect([]);
        throw error; // Re-throw para que initializeApp pueda manejarlo
      }
    }

    function renderChildrenList(children) {
      const list = document.getElementById('childrenList');
      console.log('renderChildrenList called with:', children ? children.length : 0, 'children');
      if (!list) {
        console.error('childrenList element not found');
        return;
      }
      
      if (!children || children.length === 0) {
        console.log('No children to render, showing empty message');
        list.innerHTML = '<li class="list-item">No hay ni침os registrados</li>';
        return;
      }
        list.innerHTML = children.map(child => {
          const displayName = child.displayName || child.name;
          const avatar = child.avatar || child.name.charAt(0).toUpperCase();
          
          // Informaci칩n de padres simplificada
          let parentsInfo = '';
          if (child.fatherName && child.motherName) {
            parentsInfo = `<div class="child-parents">${child.fatherName} & ${child.motherName}</div>`;
          } else if (child.fatherName) {
            parentsInfo = `<div class="child-parents">Pap치: ${child.fatherName}</div>`;
          } else if (child.motherName) {
            parentsInfo = `<div class="child-parents">Mam치: ${child.motherName}</div>`;
          }

          return `<li class="list-item child-item">
            <div class="child-info" style="flex: 1; margin-right: 10px;">
              <span class="child-avatar">${avatar}</span>
              <div class="child-details">
                <div class="child-name">${displayName}</div>
                ${parentsInfo}
                <div class="child-time">${child.totalTimePlayed || 0} min</div>
              </div>
            </div>
            <div class="delete-button-container" style="flex-shrink: 0;">
              <div class="button-group-small">
                <button onclick="editChild(${child.id})" class="btn-edit" title="Editar informaci칩n">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteChild(${child.id})" class="btn-danger btn-small" title="Eliminar ni침o">
            <i class="fas fa-trash"></i>
          </button>
              </div>
            </div>
          </li>`;
        }).join('');
    }

    function renderGamesList(games) {
      const list = document.getElementById('gamesList');
      if (!list) return;
      
      if (!games || games.length === 0) {
        list.innerHTML = '<li class="list-item">No hay juegos registrados</li>';
        return;
      }
      list.innerHTML = games.map(game => 
        `<li class="list-item">
          <div style="flex: 1; margin-right: 10px;">
          <span><i class="fas fa-dice"></i> ${game.name}</span>
          </div>
          <div class="delete-button-container" style="flex-shrink: 0;">
            <button onclick="deleteGame(${game.id})" class="btn-danger btn-small">
            <i class="fas fa-trash"></i>
          </button>
          </div>
        </li>`
      ).join('');
    }

    function updateChildSelect(children) {
      const select = document.getElementById('childSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">Seleccione un ni침o</option>' +
        (children || []).map(child => {
          const displayName = child.displayName || child.name;
          
          // Agregar informaci칩n de padres si existe para diferenciar
          let parentInfo = '';
          if (child.fatherName || child.motherName) {
            const father = child.fatherName ? child.fatherName : '';
            const mother = child.motherName ? child.motherName : '';
            const separator = father && mother ? ', ' : '';
            parentInfo = ` (${father}${separator}${mother})`;
          }
          
          return `<option value="${child.id}">${displayName}${parentInfo}</option>`;
        }).join('');
    }

    function updateGameSelect(games) {
      const select = document.getElementById('gameSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">Seleccione un juego</option>' +
        (games || []).map(game => `<option value="${game.id}">${game.name}</option>`).join('');
    }

    // Funciones de sesiones activas ROBUSTAS
    async function fetchActiveSessions() {
      try {
        console.log('Fetching active sessions from:', api + '/sessions/active');
        const res = await fetchWithRetry(api + '/sessions/active');
        console.log('Active sessions response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const newActiveSessionsData = await res.json() || [];
        console.log('Active sessions data received:', newActiveSessionsData);
        
        // Actualizar siempre para mostrar cambios
        activeSessionsData = newActiveSessionsData;
        console.log('Active sessions data updated:', activeSessionsData);
        console.log('Children cache length:', childrenCache.length);
        console.log('Games cache length:', gamesCache.length);
        renderActiveSessions();
        console.log('Active sessions rendered:', activeSessionsData.length, 'sessions');
        
      } catch (error) {
        console.error('Error fetching active sessions:', error);
        
        // NO resetear las sesiones activas en caso de error
        console.warn('Failed to fetch active sessions, keeping current data');
        
        // Solo actualizar timers con datos existentes
        if (activeSessionsData.length > 0) {
          updateExistingTimers();
        } else {
          // Si no hay datos, mostrar mensaje de no sesiones activas
          const list = document.getElementById('activeSessions');
          if (list) {
            list.innerHTML = '<li class="list-item">No hay sesiones activas</li>';
          }
        }
      }
    }

    function renderActiveSessions() {
      const list = document.getElementById('activeSessions');
      if (!list) return;
      
      // Crear un hash simple de las sesiones para detectar cambios estructurales
      const sessionHash = activeSessionsData.map(s => `${s.id}-${s.childId}-${s.gameId}-${s.duration}`).join('|');
      
      // Si no hay sesiones, mostrar mensaje
      if (activeSessionsData.length === 0) {
        if (list.innerHTML !== '<li class="list-item">No hay sesiones activas</li>') {
          list.innerHTML = '<li class="list-item">No hay sesiones activas</li>';
        }
        return;
      }
      
      // Solo re-renderizar si cambi칩 la estructura (IDs, duraci칩n, etc.)
      if (list.dataset.sessionHash !== sessionHash) {
        list.innerHTML = generateActiveSessionsHTML();
        list.dataset.sessionHash = sessionHash;
        startTimers();
        console.log('Active sessions structure updated:', activeSessionsData.length, 'sessions');
      } else {
        // Solo actualizar timers sin cambiar el DOM - menos frecuente para evitar parpadeo
        if (activeSessionsData.length > 0) {
        updateExistingTimers();
        }
      }
    }
    
    function generateActiveSessionsHTML() {
      if (!activeSessionsData || activeSessionsData.length === 0) {
        return '<li class="list-item">No hay sesiones activas</li>';
      }
      
      return activeSessionsData.map(s => {
        const child = childrenCache.find(c => c.id === s.childId);
        const game = gamesCache.find(g => g.id === s.gameId);
        
        // Debug logging
        console.log('Session debug:', {
          sessionId: s.id,
          childId: s.childId,
          childrenCacheLength: childrenCache.length,
          child: child,
          gamesCacheLength: gamesCache.length,
          game: game
        });
        
        // Si no encontramos el ni침o o juego, intentar recargar los datos
        if (!child || !game) {
          console.warn('Missing child or game data, triggering refresh...');
          setTimeout(() => {
            fetchChildren();
            fetchGames();
          }, 100);
        }
        
        // Usar displayName si existe y no es null/undefined, sino el nombre original
        const childDisplayName = child ? (child.displayName && child.displayName !== 'null' ? child.displayName : child.name) : 'Ni침o desconocido';
        const childAvatar = child ? (child.avatar || child.name.charAt(0).toUpperCase()) : '?';
        const gameName = game ? game.name : 'Juego desconocido';
        
        // Informaci칩n de padres para diferenciaci칩n
        let parentsInfo = '';
        if (child && (child.fatherName || child.motherName)) {
          if (child.fatherName && child.motherName) {
            parentsInfo = `<br><small class="parents-info"><i class="fas fa-users"></i> ${child.fatherName} & ${child.motherName}</small>`;
          } else if (child.fatherName) {
            parentsInfo = `<br><small class="parents-info"><i class="fas fa-users"></i> Pap치: ${child.fatherName}</small>`;
          } else if (child.motherName) {
            parentsInfo = `<br><small class="parents-info"><i class="fas fa-users"></i> Mam치: ${child.motherName}</small>`;
          }
        }
        
        return `<li class="list-item active" data-session-id="${s.id}" id="session-${s.id}">
          <div class="session-info">
            <strong><span class="child-avatar-small">${childAvatar}</span> <i class="fas fa-child"></i> ${childDisplayName}</strong>${parentsInfo}<br>
            <small><i class="fas fa-gamepad"></i> ${gameName}</small><br>
            <small><i class="fas fa-clock"></i> Duraci칩n: ${s.duration} min</small>
          </div>
          <div class="session-controls">
            <div class="timer" id="timer-${s.id}">Calculando...</div>
            <div class="button-group">
              <button class="btn-danger" onclick="endSession(${s.id})" style="padding: 4px 8px; font-size: 11px; margin-right: 3px;">
                <i class="fas fa-stop"></i> FIN
              </button>
              <button class="extend-time" onclick="showExtendModal(${s.id}, '${childName}')" style="padding: 4px 8px; font-size: 11px;">
                <i class="fas fa-plus"></i> +5
              </button>
            </div>
          </div>
        </li>`;
      }).join('');
    }
    
    function updateExistingTimers() {
      // Solo actualizar timers existentes sin recrear el DOM
      const list = document.getElementById('activeSessions');
      if (!list) return;
      
      activeSessionsData.forEach(s => {
        const timerElement = list.querySelector(`[data-session-id="${s.id}"] .timer`);
        if (timerElement) {
          // Actualizar directamente el contenido del timer sin recrear el elemento
          const now = Date.now();
          const elapsed = Math.floor((now - s.start) / 1000);
          const remaining = (s.duration * 60) - elapsed;
          
          if (remaining <= 0) {
            timerElement.innerHTML = '낋 <strong>Tiempo agotado</strong>';
            timerElement.className = 'timer danger';
          } else {
            const h = Math.floor(remaining / 3600);
            const m = Math.floor((remaining % 3600) / 60);
            const s = remaining % 60;
            const elapsedMin = Math.floor(elapsed / 60);
            const elapsedSec = elapsed % 60;
            
            timerElement.innerHTML = `낌勇 <strong>Restante:</strong> ${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}<br><small>Transcurrido: ${elapsedMin}:${elapsedSec.toString().padStart(2, '0')}</small>`;
            
            // Cambiar color seg칰n tiempo restante
            if (remaining <= 60) {
              timerElement.className = 'timer danger';
            } else if (remaining <= 300) {
              timerElement.className = 'timer warning';
            } else {
              timerElement.className = 'timer';
            }
          }
        }
      });
    }

    function startTimers() {
      // Limpiar timers de sesiones que ya no existen
      const currentSessionIds = activeSessionsData.map(s => s.id);
      timerIntervals.forEach((interval, sessionId) => {
        if (!currentSessionIds.includes(sessionId)) {
          clearInterval(interval);
          timerIntervals.delete(sessionId);
        }
      });

      // Crear timers solo para sesiones nuevas
      activeSessionsData.forEach(s => {
        if (!timerIntervals.has(s.id)) {
          updateTimer(s.id, s.start, s.duration);
          const interval = setInterval(() => updateTimer(s.id, s.start, s.duration), 1000);
          timerIntervals.set(s.id, interval);
        }
      });
    }

    function updateTimer(sessionId, startTime, duration) {
      const timerSpan = document.getElementById(`timer-${sessionId}`);
      if (!timerSpan) return;
      
      // Usar datos actualizados de activeSessionsData si est치n disponibles
      const sessionData = activeSessionsData.find(s => s.id === sessionId);
      const currentStartTime = sessionData ? sessionData.start : startTime;
      const currentDuration = sessionData ? sessionData.duration : duration;
      
      const now = Date.now();
      const elapsedSeconds = Math.floor((now - currentStartTime) / 1000);
      const totalSeconds = currentDuration * 60;
      const remainingSeconds = totalSeconds - elapsedSeconds;
      
      const h = String(Math.floor(remainingSeconds / 3600)).padStart(2, '0');
      const m = String(Math.floor((remainingSeconds % 3600) / 60)).padStart(2, '0');
      const s = String(remainingSeconds % 60).padStart(2, '0');
      
      // Calcular tiempo transcurrido para mostrar tambi칠n
      const elapsedMinutes = Math.floor(elapsedSeconds / 60);
      const elapsedSecs = elapsedSeconds % 60;
      
      // Actualizar clases seg칰n el tiempo restante
      timerSpan.className = 'timer';
      if (remainingSeconds <= 0) {
        timerSpan.textContent = '낋 춰Tiempo terminado!';
        timerSpan.classList.add('danger');
        if (!timerSpan.classList.contains('alerted')) {
          timerSpan.classList.add('alerted');
          const session = activeSessionsData.find(s => s.id === sessionId);
          const child = childrenCache.find(c => c.id === session.childId);
          showCustomModal(`춰Se acab칩 el tiempo para ${child ? child.name : 'este ni침o'}!`);
          endSession(sessionId);
        }
      } else if (remainingSeconds <= 60) {
        timerSpan.innerHTML = `丘멆잺 <strong>Restante:</strong> ${m}:${s}<br><small>Transcurrido: ${elapsedMinutes}:${String(elapsedSecs).padStart(2, '0')}</small>`;
        timerSpan.classList.add('warning');
        // Alerta cuando quedan 30 segundos
        if (remainingSeconds <= 30 && !timerSpan.classList.contains('alerted-30')) {
          timerSpan.classList.add('alerted-30');
          const session = activeSessionsData.find(s => s.id === sessionId);
          const child = childrenCache.find(c => c.id === session.childId);
          
          let childDisplayName = child ? (child.displayName || child.name) : 'este ni침o';
          let parentsText = '';
          if (child && (child.fatherName || child.motherName)) {
            if (child.fatherName && child.motherName) {
              parentsText = ` (${child.fatherName} & ${child.motherName})`;
            } else if (child.fatherName) {
              parentsText = ` (Pap치: ${child.fatherName})`;
            } else if (child.motherName) {
              parentsText = ` (Mam치: ${child.motherName})`;
            }
          }
          
          showStatusMessage(`춰Atenci칩n! A ${childDisplayName}${parentsText} le quedan solo ${remainingSeconds} segundos`, 'warning', sessionId);
        }
      } else {
        timerSpan.innerHTML = `낌勇 <strong>Restante:</strong> ${h}:${m}:${s}<br><small>Transcurrido: ${elapsedMinutes}:${String(elapsedSecs).padStart(2, '0')}</small>`;
      }
    }

    async function fetchSessionHistory() {
      try {
        console.log('Fetching session history from:', api + '/sessions');
        const res = await fetchWithRetry(api + '/sessions');
        console.log('Session history response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const sessions = await res.json() || [];
        console.log('Session history data received:', sessions);
        
        renderSessionHistory(sessions);
        console.log('Session history loaded successfully:', sessions);
      } catch (error) {
        console.error('Error fetching session history:', error);
        
        // En caso de error, mostrar mensaje de no historial
        const list = document.getElementById('sessionHistory');
        if (list) {
          list.innerHTML = '<li class="list-item">No hay sesiones registradas</li>';
        }
        
        console.warn('Failed to fetch session history, showing empty state');
      }
    }

    function renderSessionHistory(sessions) {
      const list = document.getElementById('sessionHistory');
      if (!list) return;
      
      if (!sessions || sessions.length === 0) {
        list.innerHTML = '<div class="history-item" style="text-align: center; padding: 20px; color: #666;"><i class="fas fa-history" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>No hay sesiones registradas</div>';
        return;
      }
      
      // Asegurar que tenemos datos de ni침os y juegos antes de renderizar
      if (childrenCache.length === 0 || gamesCache.length === 0) {
        console.log('Missing cache data, refreshing...');
        fetchChildren().then(() => fetchGames()).then(() => {
          // Re-renderizar con datos actualizados
          renderSessionHistory(sessions);
        });
        return;
      }
      
      // Mostrar las 칰ltimas 5 sesiones por defecto, resto colapsado
      const recentSessions = sessions.slice(0, 5);
      const hiddenSessions = sessions.slice(5);
      
      let html = '';
      
      // Bot칩n para expandir/colapsar si hay m치s de 5 sesiones
      if (sessions.length > 5) {
        html += `
        <button class="history-toggle" onclick="toggleHistoryView()" id="historyToggle">
          <i class="fas fa-chevron-down"></i>
          Ver ${hiddenSessions.length} sesiones anteriores
        </button>`;
      }
      
      html += recentSessions.map(s => {
        const child = childrenCache.find(c => c.id === s.childId);
        const game = gamesCache.find(g => g.id === s.gameId);
        
        // Usar nombres reales, si no se encuentran, mostrar "Desconocido"
        const childName = child ? (child.displayName && child.displayName !== 'null' ? child.displayName : child.name) : 'Ni침o desconocido';
        const gameName = game ? game.name : 'Juego desconocido';
        
        // Informaci칩n de padres para diferenciaci칩n
        let parentsInfo = '';
        if (child && (child.fatherName || child.motherName)) {
          if (child.fatherName && child.motherName) {
            parentsInfo = `<div class="history-parents"><i class="fas fa-users"></i> ${child.fatherName} & ${child.motherName}</div>`;
          } else if (child.fatherName) {
            parentsInfo = `<div class="history-parents"><i class="fas fa-users"></i> Pap치: ${child.fatherName}</div>`;
          } else if (child.motherName) {
            parentsInfo = `<div class="history-parents"><i class="fas fa-users"></i> Mam치: ${child.motherName}</div>`;
          }
        }
        
        const startTime = new Date(s.start);
        const timeStr = startTime.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit'
        });
        const dateStr = startTime.toLocaleDateString('es-ES', {
          day: '2-digit',
          month: '2-digit'
        });
        
        let statusClass, iconClass, durationText, durationClass;
        
        if (s.end) {
          // Sesi칩n finalizada
          const duration = Math.round((s.end - s.start) / 60000);
          statusClass = 'completed';
          iconClass = 'completed';
          durationText = `${duration}min`;
          durationClass = 'completed';
        } else {
          // Sesi칩n en curso - usar la misma l칩gica que renderActiveSessions
          const currentTime = Date.now();
          const elapsedSeconds = Math.floor((currentTime - s.start) / 1000);
          const totalSeconds = (s.duration || 15) * 60;
          const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);
          
          // Convertir a minutos para mostrar
          const elapsedMinutes = Math.floor(elapsedSeconds / 60);
          const totalMinutes = s.duration || 15;
          
          if (remainingSeconds <= 0) {
            statusClass = 'expired';
            iconClass = 'expired';
            durationText = 'Agotado';
            durationClass = 'expired';
          } else {
            statusClass = 'active';
            iconClass = 'active';
            durationText = `${elapsedMinutes}/${totalMinutes}min`;
            durationClass = 'active';
          }
        }
        
        return `
        <div class="history-item ${statusClass}">
          <div class="history-icon ${iconClass}">
            <i class="fas fa-${s.end ? 'check' : (statusClass === 'expired' ? 'exclamation' : 'play')}"></i>
          </div>
          <div class="history-content">
            <div class="history-title">
              <i class="fas fa-child"></i>
              ${childName}
            </div>
            ${parentsInfo}
            <div class="history-subtitle">
              <i class="fas fa-gamepad"></i>
              ${gameName}
            </div>
          </div>
          <div class="history-meta">
            <div class="history-duration ${durationClass}">
              ${durationText}
            </div>
            <div class="history-time">
              ${dateStr} ${timeStr}
            </div>
          </div>
        </div>`;
      }).join('');
      
      // Agregar sesiones ocultas si las hay
      if (hiddenSessions.length > 0) {
        html += `<div id="hiddenSessions" class="history-hidden">`;
        html += hiddenSessions.map(s => {
          const child = childrenCache.find(c => c.id === s.childId);
          const game = gamesCache.find(g => g.id === s.gameId);
          
          const childName = child ? (child.displayName && child.displayName !== 'null' ? child.displayName : child.name) : 'Ni침o desconocido';
          const gameName = game ? game.name : 'Juego desconocido';
          
          const startTime = new Date(s.start);
          const timeStr = startTime.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
          });
          const dateStr = startTime.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit'
          });
          
          let statusClass, iconClass, durationText, durationClass;
          
          if (s.end) {
            const duration = Math.round((s.end - s.start) / 60000);
            statusClass = 'completed';
            iconClass = 'completed';
            durationText = `${duration}min`;
            durationClass = 'completed';
          } else {
            const currentTime = Date.now();
            const elapsedMinutes = Math.round((currentTime - s.start) / 60000);
            const totalMinutes = s.duration || 15;
            const remainingMinutes = Math.max(0, totalMinutes - elapsedMinutes);
            
            if (remainingMinutes <= 0) {
              statusClass = 'expired';
              iconClass = 'expired';
              durationText = 'Agotado';
              durationClass = 'expired';
            } else {
              statusClass = 'active';
              iconClass = 'active';
              durationText = `${elapsedMinutes}/${totalMinutes}min`;
              durationClass = 'active';
            }
          }
          
          return `
          <div class="history-item ${statusClass}">
            <div class="history-icon ${iconClass}">
              <i class="fas fa-${s.end ? 'check' : (statusClass === 'expired' ? 'exclamation' : 'play')}"></i>
            </div>
            <div class="history-content">
              <div class="history-title">
                <i class="fas fa-child"></i>
                ${childName}
              </div>
              <div class="history-subtitle">
                <i class="fas fa-gamepad"></i>
                ${gameName}
              </div>
            </div>
            <div class="history-meta">
              <div class="history-duration ${durationClass}">
                ${durationText}
              </div>
              <div class="history-time">
                ${dateStr} ${timeStr}
              </div>
            </div>
          </div>`;
        }).join('');
        html += `</div>`;
      }
      
      list.innerHTML = html;
    }

    // Funci칩n para alternar vista del historial
    function toggleHistoryView() {
      const hiddenSessions = document.getElementById('hiddenSessions');
      const toggleBtn = document.getElementById('historyToggle');
      
      if (hiddenSessions && toggleBtn) {
        if (hiddenSessions.classList.contains('history-hidden')) {
          // Expandir
          hiddenSessions.classList.remove('history-hidden');
          toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Ocultar sesiones anteriores';
          toggleBtn.classList.add('expanded');
        } else {
          // Colapsar
          hiddenSessions.classList.add('history-hidden');
          toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Ver sesiones anteriores';
          toggleBtn.classList.remove('expanded');
        }
      }
    }

    // Funciones principales ROBUSTAS
    async function addChild() {
      const name = document.getElementById('childName').value.trim();
      const nickname = document.getElementById('childNickname').value.trim();
      const fatherName = document.getElementById('fatherName').value.trim();
      const motherName = document.getElementById('motherName').value.trim();
      
      if (!validateName(name, 'nombre del ni침o')) return;
      
      showLoading('addChildBtn', true);
      try {
        const res = await fetchWithRetry(api + '/children', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            name,
            nickname: nickname || undefined,
            fatherName: fatherName || undefined,
            motherName: motherName || undefined
          })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          
          // Manejar duplicados con sugerencias
          if (errorData.duplicate && errorData.suggestion) {
            showStatusMessage(`丘멆잺 ${errorData.suggestion}`, 'warning');
            return;
          }
          
          throw new Error(errorData.error || 'Error al agregar ni침o');
        }
        
        // Limpiar formulario
        document.getElementById('childName').value = '';
        document.getElementById('childNickname').value = '';
        document.getElementById('fatherName').value = '';
        document.getElementById('motherName').value = '';
        
        // Actualizar todos los datos despu칠s de agregar ni침o
        await Promise.all([
          fetchChildren(),
          fetchGames(),
          fetchActiveSessions(),
          fetchSessionHistory()
        ]);
        // showStatusMessage('Ni침o agregado exitosamente', 'success');
      } catch (error) {
        console.error('Error adding child:', error);
        showStatusMessage(`Error al agregar ni침o: ${error.message}`, 'error');
      } finally {
        showLoading('addChildBtn', false);
      }
    }

    async function addGame() {
      const name = document.getElementById('gameName').value.trim();
      if (!validateName(name, 'nombre del juego')) return;
      
      showLoading('addGameBtn', true);
      try {
        const res = await fetchWithRetry(api + '/games', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          throw new Error(errorData.error || 'Error al agregar juego');
        }
        
        document.getElementById('gameName').value = '';
        // Actualizar todos los datos despu칠s de agregar juego
        await Promise.all([
          fetchChildren(),
          fetchGames(),
          fetchActiveSessions(),
          fetchSessionHistory()
        ]);
        // showStatusMessage('Juego agregado exitosamente', 'success');
      } catch (error) {
        console.error('Error adding game:', error);
        showStatusMessage(`Error al agregar juego: ${error.message}`, 'error');
      } finally {
        showLoading('addGameBtn', false);
      }
    }

    async function startSession() {
      const selectedChildId = document.getElementById('selectedChildId').value;
      const gameId = document.getElementById('gameSelect').value;
      const durationInput = document.getElementById('durationInput').value;
      
      // Validar que el input no est칠 vac칤o y parsear correctamente
      if (!durationInput || durationInput.trim() === '') {
        showStatusMessage('Por favor ingrese un tiempo v치lido', 'error');
        return;
      }
      
      const duration = parseInt(durationInput.trim());
      
      console.log('Starting session:', { selectedChildId, gameId, duration, originalInput: durationInput });
      
      if (!validateSession(selectedChildId, gameId, duration)) return;
      
      // Verificar que el ni침o y juego existen en el cach칠
      const child = childrenCache.find(c => c.id == selectedChildId);
      const game = gamesCache.find(g => g.id == gameId);
      
      if (!child) {
        showStatusMessage('Error: Ni침o no encontrado en la lista', 'error');
        await fetchChildren(); // Recargar datos
        return;
      }
      
      if (!game) {
        showStatusMessage('Error: Juego no encontrado en la lista', 'error');
        await fetchGames(); // Recargar datos
        return;
      }
      
      showLoading('startBtn', true);
      try {
        const requestBody = { 
          childId: Number(selectedChildId), 
          gameId: Number(gameId), 
          duration: Number(duration) 
        };
        
        console.log('Request body:', requestBody);
        
        const res = await fetchWithRetry(api + '/sessions/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        console.log('Response status:', res.status);
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          throw new Error(errorData.error || 'Error al iniciar sesi칩n');
        }
        
        const result = await res.json();
        console.log('Session started:', result);
        
        // Actualizar datos inmediatamente despu칠s de iniciar sesi칩n
        await Promise.all([
          fetchActiveSessions(),
          fetchSessionHistory(),
          fetchChildren(), // Asegurar datos actualizados
          fetchGames()
        ]);
        // showStatusMessage('Sesi칩n iniciada exitosamente', 'success');
        
        // Limpiar alertas de sesiones anteriores
        clearAllSessionAlerts();
      } catch (error) {
        console.error('Error starting session:', error);
        showStatusMessage(`Error al iniciar sesi칩n: ${error.message}`, 'error');
      } finally {
        showLoading('startBtn', false);
      }
    }

    async function endSession(sessionId) {
      try {
        const res = await fetchWithRetry(api + '/sessions/end', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          throw new Error(errorData.error || 'Error al finalizar sesi칩n');
        }
        
        // Limpiar timer
        if (timerIntervals.has(sessionId)) {
          clearInterval(timerIntervals.get(sessionId));
          timerIntervals.delete(sessionId);
        }
        
        // Actualizar datos inmediatamente despu칠s de finalizar sesi칩n
        await Promise.all([
          fetchActiveSessions(),
          fetchSessionHistory(),
          fetchChildren(), // Asegurar datos actualizados
          fetchGames()
        ]);
        // showStatusMessage('Sesi칩n finalizada', 'success');
        
        // Limpiar alertas de esta sesi칩n
        clearSessionAlert(sessionId);
      } catch (error) {
        console.error('Error ending session:', error);
        showStatusMessage(`Error al finalizar sesi칩n: ${error.message}`, 'error');
      }
    }

    // Funci칩n para extender tiempo ROBUSTA
    async function confirmExtendTime() {
      if (!currentExtendSession) {
        showStatusMessage('No hay sesi칩n seleccionada para extender', 'error');
        return;
      }
      
      const additionalTime = parseInt(document.getElementById('extendTimeInput').value);
      if (isNaN(additionalTime) || additionalTime < 1 || additionalTime > 60) {
        showStatusMessage('El tiempo adicional debe estar entre 1 y 60 minutos', 'error');
        return;
      }
      
      // Verificar que la sesi칩n a칰n existe
      const session = activeSessionsData.find(s => s.id === currentExtendSession);
      if (!session) {
        showStatusMessage('La sesi칩n ya no est치 activa', 'error');
        closeExtendModal();
        return;
      }
      
      try {
        console.log('Extending session:', currentExtendSession, 'by', additionalTime, 'minutes');
        
        const res = await fetchWithRetry(api + '/sessions/extend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            sessionId: currentExtendSession, 
            additionalTime: additionalTime 
          })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          throw new Error(errorData.error || 'Error al extender tiempo');
        }
        
        const result = await res.json();
        console.log('Time extended successfully:', result);
        
        closeExtendModal();
        
        // Actualizar datos inmediatamente
        await Promise.all([
          fetchActiveSessions(),
          fetchSessionHistory()
        ]);
        
        // Reiniciar timers para usar los datos actualizados
        startTimers();
        
        showStatusMessage(`+${additionalTime} min`, 'success');
      } catch (error) {
        console.error('Error extending time:', error);
        showStatusMessage(`Error al extender tiempo: ${error.message}`, 'error');
      }
    }

    // Funciones de eliminaci칩n ROBUSTAS
    async function deleteChild(childId) {
      if (!confirm('쮼st치 seguro de que desea eliminar este ni침o?')) return;
      
      try {
        const res = await fetchWithRetry(`${api}/children/${childId}`, {
          method: 'DELETE'
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          throw new Error(errorData.error || 'Error al eliminar ni침o');
        }
        
        // Actualizar todos los datos despu칠s de eliminar ni침o
        await Promise.all([
          fetchChildren(),
          fetchGames(),
          fetchActiveSessions(),
          fetchSessionHistory()
        ]);
        // showStatusMessage('Ni침o eliminado', 'success');
      } catch (error) {
        console.error('Error deleting child:', error);
        showStatusMessage(`Error al eliminar ni침o: ${error.message}`, 'error');
      }
    }

    async function deleteGame(gameId) {
      if (!confirm('쮼st치 seguro de que desea eliminar este juego?')) return;
      
      try {
        const res = await fetchWithRetry(`${api}/games/${gameId}`, {
          method: 'DELETE'
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          throw new Error(errorData.error || 'Error al eliminar juego');
        }
        
        // Actualizar todos los datos despu칠s de eliminar juego
        await Promise.all([
          fetchChildren(),
          fetchGames(),
          fetchActiveSessions(),
          fetchSessionHistory()
        ]);
        // showStatusMessage('Juego eliminado', 'success');
      } catch (error) {
        console.error('Error deleting game:', error);
        showStatusMessage(`Error al eliminar juego: ${error.message}`, 'error');
      }
    }

    // Funciones de edici칩n de ni침os
    function editChild(childId) {
      const child = childrenCache.find(c => c.id === childId);
      if (!child) {
        showStatusMessage('Ni침o no encontrado', 'error');
        return;
      }

      currentEditChild = childId;
      
      // Llenar el modal con los datos actuales
      document.getElementById('editChildName').value = child.name || '';
      document.getElementById('editChildNickname').value = child.nickname || '';
      document.getElementById('editFatherName').value = child.fatherName || '';
      document.getElementById('editMotherName').value = child.motherName || '';
      
      // Mostrar el modal
      document.getElementById('editChildModal').classList.add('show');
    }

    function closeEditChildModal() {
      document.getElementById('editChildModal').classList.remove('show');
      currentEditChild = null;
    }

    async function confirmEditChild() {
      if (!currentEditChild) {
        showStatusMessage('No hay ni침o seleccionado para editar', 'error');
        return;
      }

      const name = document.getElementById('editChildName').value.trim();
      const nickname = document.getElementById('editChildNickname').value.trim();
      const fatherName = document.getElementById('editFatherName').value.trim();
      const motherName = document.getElementById('editMotherName').value.trim();
      
      if (!validateName(name, 'nombre del ni침o')) {
        return;
      }
      
      try {
        const res = await fetchWithRetry(`${api}/children/${currentEditChild}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            name,
            nickname: nickname || undefined,
            fatherName: fatherName || undefined,
            motherName: motherName || undefined
          })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Error desconocido' }));
          throw new Error(errorData.error || 'Error al editar ni침o');
        }
        
        // Actualizar todos los datos despu칠s de editar ni침o
        await Promise.all([
          fetchChildren(),
          fetchGames(),
          fetchActiveSessions(),
          fetchSessionHistory()
        ]);
        
        closeEditChildModal();
        showStatusMessage('Informaci칩n del ni침o actualizada', 'success');
      } catch (error) {
        console.error('Error editing child:', error);
        showStatusMessage(`Error al editar ni침o: ${error.message}`, 'error');
      }
    }

    // Inicializaci칩n ROBUSTA
    // Funci칩n para migrar ni침os existentes
    async function migrateExistingChildren() {
      try {
        const response = await fetch('/children/migrate', { method: 'POST' });
        const result = await response.json();
        
        if (result.migrated > 0) {
          console.log(`Migrated ${result.migrated} children with new display IDs`);
          await fetchChildren(); // Recargar la lista
        }
      } catch (error) {
        console.error('Error migrating children:', error);
      }
    }

    async function initializeApp() {
      if (isInitialized) return;
      
      try {
        console.log('Initializing app...');
        console.log('API endpoint:', api);
        
        // Test de conectividad primero
        try {
          const testResponse = await fetch(api + '/admin/status');
          if (testResponse.ok) {
            const status = await testResponse.json();
            console.log('Server status:', status);
            console.log('Server has', status.children, 'children,', status.games, 'games,', status.activeSessions, 'active sessions');
          } else {
            console.error('Server not responding:', testResponse.status);
          }
        } catch (error) {
          console.error('Cannot connect to server:', error);
        }
        
        // Cargar datos secuencialmente para mejor debugging
        try {
          console.log('Loading children...');
          await fetchChildren();
          
          // Verificar si se cargaron todos los ni침os
          console.log('Children loaded, checking cache...');
          console.log('Current childrenCache length:', childrenCache.length);
          
          // Si hay pocos ni침os, intentar recargar
          if (childrenCache.length < 3) {
            console.log('Few children detected, forcing reload...');
            await fetchChildren();
          }
        } catch (error) {
          console.error('Failed to load children, continuing...', error);
        }
        
        try {
          console.log('Loading games...');
          await fetchGames();
        } catch (error) {
          console.error('Failed to load games, continuing...', error);
        }
        
        // Migrar ni침os existentes si es necesario
        try {
          console.log('Migrating existing children...');
          await migrateExistingChildren();
        } catch (error) {
          console.error('Failed to migrate children, continuing...', error);
        }
        
        // Cargar sesiones activas
        try {
          console.log('Loading active sessions...');
          await fetchActiveSessions();
        } catch (error) {
          console.error('Failed to load active sessions, continuing...', error);
        }
        
        // Cargar historial de sesiones
        try {
          console.log('Loading session history...');
          await fetchSessionHistory();
        } catch (error) {
          console.error('Failed to load session history, continuing...', error);
        }
        
        // Cargar estad칤sticas del dashboard
        try {
          console.log('Loading dashboard stats...');
          await fetchDashboardStats();
          updateDashboard();
        } catch (error) {
          console.error('Failed to load dashboard stats, continuing...', error);
        }
        
             // Solicitar permisos de notificaci칩n
             try {
               console.log('Requesting notification permission...');
               await requestNotificationPermission();
             } catch (error) {
               console.error('Failed to request notification permission, continuing...', error);
             }
             
             // Inicializar sistema de b칰squeda de ni침os
             try {
               console.log('Initializing child search system...');
               initializeChildSearch();
             } catch (error) {
               console.error('Failed to initialize child search system, continuing...', error);
        }
        
        // Configurar intervalos de actualizaci칩n - Optimizados para evitar parpadeo
        // Actualizar sesiones activas cada 30 segundos para mantener datos actualizados sin parpadeo
        setInterval(fetchActiveSessions, 30000);
        
        // Actualizar historial cada 120 segundos
        setInterval(fetchSessionHistory, 120000);
        
        // Actualizar ni침os y juegos cada 60 segundos
        setInterval(() => {
          fetchChildren();
          fetchGames();
        }, 60000);
        
        // Limpiar timers al cerrar la p치gina
        window.addEventListener('beforeunload', () => {
          timerIntervals.forEach(interval => clearInterval(interval));
        });
        
        isInitialized = true;
        // showStatusMessage('Aplicaci칩n cargada correctamente', 'success');
        console.log('App initialized successfully');
        
        // Ocultar todas las secciones inicialmente para evitar parpadeo
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Restaurar secci칩n activa del localStorage
        const savedSection = localStorage.getItem('activeSection');
        if (savedSection) {
            showSection(savedSection);
        } else {
            // Si no hay secci칩n guardada, mostrar dashboard por defecto
            localStorage.setItem('activeSection', 'dashboard');
            showSection('dashboard');
        }
      } catch (error) {
        console.error('Critical error initializing app:', error);
        showStatusMessage('Error cr칤tico al cargar la aplicaci칩n', 'error');
      }
    }

    // Funci칩n de recuperaci칩n autom치tica
    async function recoverFromErrors() {
      console.log('Attempting to recover from errors...');
      try {
        await initializeApp();
      } catch (error) {
        console.error('Recovery failed:', error);
        setTimeout(recoverFromErrors, 5000); // Reintentar en 5 segundos
      }
    }
    
    // Funci칩n para forzar sincronizaci칩n completa
    // Funci칩n interna para debugging - no visible para usuarios
    async function forceSync() {
      console.log('Internal sync triggered...');
      try {
        childrenCache = [];
        gamesCache = [];
        
        await Promise.all([
          fetchChildren(),
          fetchGames(),
          fetchActiveSessions(),
          fetchSessionHistory()
        ]);
        
        renderChildrenList(childrenCache);
        renderGamesList(gamesCache);
        updateChildSelect(childrenCache);
        updateGameSelect(gamesCache);
        
        console.log('Internal sync completed');
      } catch (error) {
        console.error('Internal sync failed:', error);
      }
    }
    
    // Sincronizaci칩n autom치tica cuando la p치gina vuelve a ser visible
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('Page became visible, forcing sync...');
        // forceSync(); // Comentado para evitar alertas molestas
      }
    });
    
    // Sincronizaci칩n cuando se enfoca la ventana
    window.addEventListener('focus', () => {
      console.log('Window focused, forcing sync...');
      // forceSync(); // Comentado para evitar alertas molestas
    });

    // Manejador de atajos de teclado
    document.addEventListener('keydown', (event) => {
      // Solo activar atajos si no se est치 escribiendo en un input
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return;
      }
      
      const key = event.key;
      if (keyboardShortcuts[key]) {
        event.preventDefault();
        keyboardShortcuts[key]();
      }
      
      // Atajo para abrir/cerrar men칰 m칩vil (tecla 'm')
      if (key === 'm' || key === 'M') {
        event.preventDefault();
        toggleMobileMenu();
      }
    });

    // Inicializar cuando se carga la p치gina
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp().catch(() => {
        console.log('Initial initialization failed, starting recovery...');
        setTimeout(recoverFromErrors, 2000);
      });
    });
  </script>
</body>
</html>